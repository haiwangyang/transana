---
title: "tximport"
author: "Haiwang Yang"
date: "6/19/2018"
output: html_document
---

```{r setup, include=FALSE}
library("pheatmap")
library("RColorBrewer")
library("ggplot2")
library(Hmisc)
library(tximportData)
library(tximport)
library(rjson)

library(DESeq2)

base_path = "/Users/yangh13/transana/transana/"
knitr::opts_chunk$set(echo = TRUE)
```


## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r get basics}
tissues_in_final_order = c( "wb", "go", "re", "ge", "tx", "dg", "hd", "ac")
tissues_in_final_order_no_ge = c( "wb", "go", "re", "tx", "dg", "hd", "ac")

species = "dmel"
dir <- paste0(base_path, "data/")
samples <- read.table(file.path(dir, paste0(species, ".design")), header = TRUE)
files <- file.path(dir, "salmon", "FB", samples$sample_id, "quant.sf")
names(files) <- samples$sample_id
tx2gene = read.table(paste0(dir, species, ".tx2gene"), header=TRUE)
gene2ortho = read.table(paste0(dir, species, ".ortholog"), header=TRUE)
gene2symbol = read.table(paste0(dir, species, ".FBgn2symbol"), header=TRUE)
fetch_files_by_tissue = function(strain, tissue, files){
  return(files[ grepl(paste0(strain, "_"), files) & grepl(paste0("_", tissue, "_"), files)])
}

```

```{r run transcript-level tximport and deseq2 based on sex}

for (strain in c("w1118", "oreR")){
  for (tissue in tissues_in_final_order){

  part_files = fetch_files_by_tissue(strain, tissue, files)
  part_samples = samples[samples$sample_id %in% names(part_files),]
  part_samples$sex = factor(part_samples$sex, levels = c("m", "f"))
  
  txi <- tximport(part_files, type = "salmon", txOut = TRUE) # transcript-level output
  
  dds <- DESeqDataSetFromTximport(txi, part_samples, ~sex)
  dds = DESeq(dds)

  res = results(dds) # log2fc is f/m, so Yp1-transcript has 13
  res_sig = res[res$padj<alpha & !is.na(res$padj),]
  res_sig_female = res_sig[res_sig$log2FoldChange>0,]
  res_sig_male = res_sig[res_sig$log2FoldChange<0,]
  FBtrs_res_sig_female = rownames(res_sig_female)  
  FBtrs_res_sig_male = rownames(res_sig_male)

  FBgns_all = rownames(part_res)
  FBgns_all_minus_m = FBgns_all[! FBgns_all %in% FBgns_res_sig_male]
  FBgns_unbiased = FBgns_all_minus_m[! FBgns_all_minus_m %in% FBgns_res_sig_female]
  df_bias_m = data.frame("FBgn_ID"=as.character(unlist(FBgns_res_sig_male)),"bias"="male")
  df_bias_unbias = data.frame("FBgn_ID"=FBgns_unbiased,"bias"="unbiased")
  df_bias_f = data.frame("FBgn_ID"=as.character(unlist(FBgns_res_sig_female)),"bias"="female")
  df_bias_total = rbind(df_bias_m,df_bias_unbias,df_bias_f)
  df_bias_total$FBgn_ID = as.character(df_bias_total$FBgn_ID)
  df_bias_total = df_bias_total[order(df_bias_total$FBgn_ID),]
  
  normCounts = counts(dds, normalized=TRUE)
  x = as.data.frame(log2(normCounts+1))
  x$MAplot_mean = as.numeric(apply(x, 1, mean))
  x$MAplot_log2FoldChange = res$log2FoldChange
    
  pdf(paste0(base_path, "/output/", strain, ".", tissue, ".MAplot.pdf"),width=40,height=40)

  x$MAplot_log2FoldChange[x$MAplot_log2FoldChange > 2] = 2
  x$MAplot_log2FoldChange[x$MAplot_log2FoldChange < -2] = -2
  plot(x$MAplot_mean, x$MAplot_log2FoldChange, col=x$col, pch = 19, cex = 8, xlim=c(0,18), cex.axis=5, cex.lab=5, cex.main=5, main = paste0(capitalize(species), " ", get_tissueFull(tissue) ), xlab="mean expression (log2 normalized read count + 1)", ylab="log2 fold change of male to female")
  text(16, 1.5, labels = dim(df_bias_m)[1], col = rgb(0,0,1), cex = 20)
  text(16, -1.5, labels = dim(df_bias_f)[1], col = rgb(1,0,0), cex = 20)
  # #text(x$MAplot_mean_R1, x$MAplot_log2FoldChange + 0.1, labels = x$label)
  dev.off()
  
  
  head(res['FBtr0071419',])
  head(res['FBtr0346261',])
  
  summary(res,alpha=0.05)
  
  
```